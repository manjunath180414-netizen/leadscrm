<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HIS Academy Admin Panel</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- SheetJS for Excel Export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: linear-gradient(to bottom, #0a0f2c, #050a1f);
  color: white;
  padding: 20px;
}

.card {
  background: #111a3a;
  padding: 20px;
  border-radius: 15px;
  margin-bottom: 20px;
  box-shadow: 0 0 10px black;
}

button {
  background: #FFD700;
  color: black;
  padding: 12px;
  border: none;
  border-radius: 10px;
  width: 100%;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}

.hidden { display: none; }
.gold { color: gold; }
</style>
</head>
<body>

<h2 class="gold">ðŸ”¥ HIS Academy Admin Panel</h2>

<!-- LOGIN SECTION -->
<div class="card" id="loginSection">
  <h3>Admin Login</h3>
  <button onclick="adminLogin()">Login with Google</button>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="adminDashboard">
  <h3>Total Leads: <span id="totalLeads">0</span></h3>
  <button onclick="downloadExcel()">Download Excel</button>
  <button onclick="logout()">Logout</button>
</div>

<script>

/* ðŸ”¥ FIREBASE CONFIG */
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC0Jf7YY9swFu_JAY-TeDfvlMCz1Iw23MU",
  authDomain: "leadgen-da6b8.firebaseapp.com",
  projectId: "leadgen-da6b8",
  storageBucket: "leadgen-da6b8.firebasestorage.app",
  messagingSenderId: "462081996744",
  appId: "1:462081996744:web:177127efe807c0f6b332fd",
  measurementId: "G-FXZFGYM89Y"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let allUsers = [];

/* ADMIN LOGIN */
async function adminLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const result = await auth.signInWithPopup(provider);
    const user = result.user;

    if(user.email !== "hisacademyofficial@gmail.com"){
      alert("Access Denied!");
      auth.signOut();
      return;
    }

  }catch(error){
    alert(error.message);
  }
}

/* AUTH CHECK */
auth.onAuthStateChanged(async (user)=>{
  if(user && user.email === "hisacademyofficial@gmail.com"){

    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("adminDashboard").classList.remove("hidden");

    loadLeads();

  }else{
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("adminDashboard").classList.add("hidden");
  }
});

/* LOAD ALL USERS */
async function loadLeads(){
  const snapshot = await db.collection("users").get();

  allUsers = [];

  snapshot.forEach(doc=>{
    const data = doc.data();

    allUsers.push({
      Name: data.name || "",
      Phone: data.phone || "",
      Email: data.email || "",
      ReferralCode: data.referralCode || "",
      ReferralCount: data.referralCount || 0,
      Unlocked: data.unlocked ? "Yes" : "No",
      JoinedDate: data.joinedDate ? data.joinedDate.toDate().toLocaleString() : ""
    });
  });

  document.getElementById("totalLeads").innerText = allUsers.length;
}

/* DOWNLOAD EXCEL */
function downloadExcel(){

  if(allUsers.length === 0){
    alert("No data found.");
    return;
  }

  const worksheet = XLSX.utils.json_to_sheet(allUsers);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Leads");

  XLSX.writeFile(workbook, "HIS_Academy_Leads.xlsx");
}

/* LOGOUT */
function logout(){
  auth.signOut();
}

</script>

</body>
</html>
